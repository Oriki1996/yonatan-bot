# fallback_responses.py - מערכת תשובות מוכנות מראש
"""
מערכת תשובות מוכנות מראש לבוט יונתן
משמשת כ-fallback כאשר ה-API של Google לא זמין (quota exceeded, שגיאות, וכו')
"""

import re
from typing import Dict, List, Optional


class FallbackResponseSystem:
    """מערכת תשובות מוכנות מראש כאשר ה-API לא זמין"""
    
    def __init__(self):
        self.responses_db = self._load_responses_database()
    
    def _load_responses_database(self) -> Dict:
        """טעינת בסיס נתונים של תשובות מוכנות לפי נושאים"""
        return {
            "greeting": {
                "keywords": ["שלום", "היי", "בוקר טוב", "ערב טוב", "START_CONVERSATION", "הלו"],
                "responses": [
                    """שלום! אני יונתן, פסיכו-בוט חינוכי המבוסס על עקרונות CBT. 🤖

אני כאן לעזור לך בגידול המתבגר שלך. גם אם המערכת שלי עמוסה היום, אני עדיין יכול לתת לך כלים וטיפים מועילים.

`CARD[עקרון הבסיס|הקשר שלך עם המתבגר שלך הוא הדבר הכי חשוב. כל טכניקה עובדת רק כשיש אמון ואהבה.]`

איך אני יכול לעזור לך היום? תוכל לשתף איתי:
[בעיות תקשורת] [קשיים בלימודים] [חרדה ולחץ] [זמן מסך] [בעיות חברתיות]""",

                    """ברוך/ה הבא/ה! אני יונתן, המלווה הדיגיטלי שלך בעולם ההורות למתבגרים. 👋

אני מבוסס על עקרונות הטיפול הקוגניטיבי-התנהגותי (CBT) ונוצרתי כדי לתמוך בהורים כמוך.

**מה אני יכול לעזור בו:**
- תקשורת יעילה יותר עם המתבגר שלך
- התמודדות עם התנהגויות מאתגרות  
- כלים לירידת מתחים בבית
- הבנת עולמו הפנימי של המתבגר

גם אם אני במצב מוגבל היום, אני עדיין כאן בשבילך. על מה תרצה לדבר?"""
                ]
            },
            
            "communication_issues": {
                "keywords": ["תקשורת", "ריבים", "ויכוחים", "לא מדבר", "צועק", "לא שומע", "לא מקשיב", "לא מכבד", "חוצפה"],
                "responses": [
                    """**שיפור התקשורת עם המתבגר** 🗣️

`CARD[מה מאחורי "חוסר כבוד"|לעתים מה שנראה כחוסר כבוד הוא בעצם: פחד, תסכול, חוסר יכולת להתבטא, או צורך בעצמאות.]`

**כשיש ויכוח או מתח:**

1. **עצור רגע** - כשאתה כועס, המתבגר יהיה כועס יותר
2. **שקף מה ששמעת** - "נשמע לי שאתה מרגיש..."
3. **הכר ברגש** - "אני רואה שזה מתסכל אותך"
4. **חפש פתרון יחד** - "איך נוכל לפתור את זה?"

**דוגמאות למעבר משפה "מול" לשפה "עם":**
- במקום: "תפסיק לצעוק!" → "אני רואה שאתה כועס, בוא נדבר"
- במקום: "אתה לא מכבד!" → "איך נוכל לדבר בדרך שטובה לשנינו?"
- במקום: "תעשה מה שאמרתי!" → "בוא נחשוב יחד איך לפתור את זה"

[הקשבה קודם כל] [זיהוי הרגש] [פתרון משותף]""",

                    """**כשהמתבגר "לא מקשיב"** 👂

האמת? לעתים הבעיה לא שהם לא שומעים - הבעיה שהם מרגישים שלא שווה להקשיב.

`CARD[מחזור התקשורת השלילי|הורה מתסכל → דיבור בטון כועס → מתבגר נסגר → הורה יותר מתסכל. איך שוברים? מישהו צריך להתחיל לדבר אחרת.]`

**אסטרטגיות שעובדות:**

**1. תיזמון נכון**
- לא כשהם עם חברים, עייפים או רעבים
- "מתי יהיה לך זמן שנדבר?"

**2. עניין אמיתי**
- במקום להטיף, תתעניין: "איך היה לך היום?"
- "מה הדבר הכי מעניין שקרה לך השבוע?"

**3. דיבור על הקשר עצמו**
- "נשמע לי שאנחנו לא מבינים אחד את השני לאחרונה"
- "איך אני יכול לדבר איתך בצורה שיותר נוחה לך?"

**4. מודל של הקשבה**
- תן לו לדבר שלוש משפטים בלי להגיב
- תגיד: "ספר לי עוד על זה" במקום לייעץ מיד

[תיזמון נכון] [עניין אמיתי] [דוגמא של הקשבה]"""
                ]
            },
            
            "anxiety_stress": {
                "keywords": ["חרדה", "לחץ", "מתח", "חרד", "פוחד", "דאגה", "בהלה", "מתוח", "עצבני", "מבוהל"],
                "responses": [
                    """**עזרה למתבגר עם חרדה ולחץ** 😰

`CARD[למה מתבגרים חרדים יותר היום|רשתות חברתיות, לחץ אקדמי, חוסר ודאות לגבי העתיד, והרגשה של צורך להיות מושלמים.]`

**כשהמתבגר שלך חרד או מתוח:**

**שלב 1: הכרה והכלה**
- "אני רואה שזה מלחיץ אותך" (לא "אל תדאג")
- "חרדה זה נורמלי, ואני כאן לעזור לך להתמודד"
- תן לו להרגיש שמבינים אותו

**שלב 2: טכניקות הרגעה מיידיות**
- נשימה איטית: 4 שניות נשימה פנימה, 4 שניות החוצה
- הארקה: 5 דברים שרואה, 4 שמרגיש, 3 ששומע, 2 שמריח, 1 שטועם
- תזכורת: "הרגש הזה יעבור, זה זמני"

**שלב 3: חשיבה מועילה**
- "מה הדבר הכי גרוע שיכול לקרות?"
- "כמה סביר שזה באמת יקרה?"
- "איך התמודדת עם דברים קשים בעבר?"
- "מה היית אומר לחבר הכי טוב שלך במצב דומה?"

[הכלה ראשונה] [הרגעה מיידית] [חשיבה מועילה]""",

                    """**לחץ לימודים ובחינות** 📚

המתבגרים היום חווים לחץ לימודים יותר מתמיד.

`CARD[מעגל הלחץ|לחץ → דחיינות → יותר לחץ → יותר דחיינות. איך שוברים? חלוקה למשימות קטנות ומנוחה.]`

**איך עוזרים:**

**אל תגיד:**
- "אל תדאג, זה לא כזה נורא"
- "פשוט תתחיל ללמוד יותר"
- "בזמני זה היה הרבה יותר קשה"

**במקום זה:**
- "נשמע שזה באמת מלחיץ"
- "בוא נחשוב יחד איך לעשות את זה יותר נוח"
- "מה החלק הכי קשה מבחינתך?"

**כלים מעשיים:**
1. **חלוקת משימות**: במקום "תכין לבגרות", תגיד "בוא נתחיל עם פרק אחד"
2. **לוח זמנים**: יחד תכינו תוכנית שמכילה גם הפסקות ובילוי
3. **חיזוק תהליך**: "ראיתי שישבת ללמוד חצי שעה - זה התחלה מעולה!"

**למתי לדאוג באמת:**
- אם החרדה מונעת ממנו לצאת מהבית
- אם יש התקפי בהלה חוזרים
- אם הוא מפסיק לאכול או לישון

[הכלה ללא זלזול] [חלוקה למשימות] [חיזוק התהליך]"""
                ]
            },
            
            "anger_aggression": {
                "keywords": ["כועס", "זעם", "תוקפני", "צועק", "מכה", "משתולל", "התפרץ", "אלימות", "זועם"],
                "responses": [
                    """**התמודדות עם כעס והתפרצויות** 😡

`CARD[מאחורי הכעס|כעס הוא לעיתים מסיכה על כאב, פחד, תסכול, חוסר אונים או בושה. השאלה: מה מתחת לכעס?]`

**באמצע התפרצות:**
1. **הישאר רגוע** - הכעס שלך יחזק את הכעס שלו
2. **אל תנסה לדבר הגיון** - במצב כעס המוח הרגשי שולט
3. **תן מרחב** - "אני רואה שאתה כועס, בוא נדבר כשתרגיש מוכן"
4. **הגן על עצמך** - אל תקבל אלימות או השפלות

**אחרי שהכעס חלף:**
- "מה גרם לך להתפוצץ ככה?"
- "איך אתה מרגיש עכשיו?"
- "בוא נחשוב על דרכים אחרות להגיב בפעם הבאה"

**מניעה:**
- זהה אותות מוקדמים (טון קול, שפת גוף)
- למד את הטריגרים שלו
- תכננו יחד אסטרטגיות: "מה נעשה כשאתה מרגיש שאתה מתחיל לכעוס?"

**דגלים אדומים - פנה לעזרה מקצועית:**
- אלימות כלפי אחרים או רכוש
- איומים מילוליים חוזרים
- פגיעה עצמית

[שמירה על רוגע] [מרחב להרגעה] [חיפוש הסיבה האמיתית]"""
                ]
            },
            
            "screen_time": {
                "keywords": ["מסך", "טלפון", "מחשב", "גיימינג", "אינטרנט", "רשתות חברתיות", "יוטיוב", "טיקטוק", "נטפליקס"],
                "responses": [
                    """**המאבק על זמן מסך** 📱

זה אחד האתגרים הגדולים של ההורות המודרנית!

`CARD[למה זה כל כך ממכר|אפליקציות מתוכננות ליצור התמכרות: דופמין, התראות, אלגוריתמים, פחד מפספוס (FOMO) - כולם עובדים נגדכם.]`

**אסטרטגיות שעובדות:**

**1. הסכם משפחתי (לא פקודות)**
- "בואו נחשוב יחד איך לאזן בין מסך לחיים אמיתיים"
- צרו ביחד חוקים הגיוניים לכולם
- כלול את המתבגר בקבלת ההחלטות

**2. חלופות מעניינות**
- במקום "תפסיק עם הטלפון" תציע פעילויות מגניבות
- מצא מה באמת מעניין אותו מעבר למסך
- תכנן פעילויות משפחתיות ללא מסכים

**3. דוגמא אישית**
- איך השימוש במסך שלך?
- ילדים לומדים יותר ממה שרואים מאשר ממה ששומעים

**4. הדרגתיות**
- אל תנתק בבת אחת (זה יוצר מלחמה)
- התחל מאזורים מוגדרים (ארוחות, שעה לפני שינה)
- הוסף פעילויות טובות לפני שמגבילים את הרעות

[הסכמים משותפים] [חלופות מעניינות] [דוגמא אישית] [שינוי הדרגתי]""",

                    """**כשזמן המסך יוצא מכלל שליטה** 🚨

איך יודעים שמדובר בבעיה אמיתית ולא רק ב"תקופה"?

**סימני אזהרה:**
- הפסקת פעילויות שהיו מהנות (ספורט, חברים)
- בעיות שינה (נרדם מאוחר, קשה להתעורר)
- התפרצויות חזקות כשמנסים להגביל
- ירידה משמעותית בציונים
- הימנעות מאירועים חברתיים/משפחתיים

`CARD[זהירות מתוכן פוגע|אם יש חשש לחשיפה לתכנים לא מתאימים, קשר מקוון מפוקפק, או התנהגויות מסוכנות ברשת - עזרה מקצועית מיד.]`

**תוכנית פעולה:**

**שלב 1: הבנה לא שיפוט**
- "מה אתה הכי אוהב לעשות במסך?"
- "איך אתה מרגיש כשאין לך גישה לטלפון?"
- **אל תשפוט - רק תבין את החיבור שלו**

**שלב 2: הגבלה חכמה**
- התחל מזמנים קבועים ללא מסך (אוכל, שיחה משפחתית)
- הסכם על שעת סיום ערבית
- השתמש בכלים טכנולוגיים (Screen Time, Family Link)

**שלב 3: מעורבות ומעקב**
- תן לו לעקוב על הזמן בעצמו
- שיתוף במצב במקום ביקורת: "איך אתה מרגיש עם השינוי?"

[הבנה לפני הגבלה] [שינוי הדרגתי] [מעורבות במקום שליטה]"""
                ]
            },
            
            "depression_mood": {
                "keywords": ["דיכאון", "עצוב", "אפטיה", "לא מעוניין", "מצב רוח", "בדידות", "חוסר מוטיבציה", "ירוד"],
                "responses": [
                    """**כשהמתבגר במצב רוח נמוך** 😔

תחילה: איך מבחינים בין "תקופה קשה" רגילה לבין דיכאון שדורש התערבות?

`CARD[מיתוס מזיק|"זה רק גיל ההתבגרות" - לא נכון! דיכאון במתבגרים הוא אמיתי, כואב, ודורש התייחסות רצינית.]`

**סימני אזהרה לדיכאון אמיתי:**
- אובדן עניין בדברים שהיו מהנים (ספורט, חברים, תחביבים)
- שינויים משמעותיים בשינה (הרבה יותר או פחות)
- שינויים באכילה (הרבה יותר או פחות)
- תחושות של חוסר ערך או אשמה מוגזמת
- קושי בריכוז
- עייפות קיצונית
- דיבור על מוות, רצון להיעלם

**איך עוזרים:**

**1. זמינות ללא ניסיון "תיקון"**
- "אני כאן בשבילך, גם אם אתה לא רוצה לדבר עכשיו"
- אל תגיד "תסתכל על הצד החיובי" - זה לא עוזר

**2. פעילויות קטנות יחד**
- המטרה לא אושר מיידי אלא תנועה קטנה
- "בוא נצא לקנות משהו בחנות הקרובה"
- "בוא נשב בחוץ 10 דקות"

**3. חיזוק על כל צעד**
- "ראיתי שהתקלחת היום - זה לא פשוט כשקשה"
- "תודה שיצאת איתנו לארוחה"

**מתי לפנות לעזרה מקצועית מיד:**
- דיבור על פגיעה עצמית או מוות
- אם המצב נמשך יותר מ-2 שבועות ללא שיפור
- אם פסק לתפקד (לא הולך לבית ספר, לא אוכל, לא יוצא)

[זמינות ללא תיקון] [פעילות לפני אושר] [זיהוי מתי צריך עזרה מקצועית]"""
                ]
            },
            
            "social_issues": {
                "keywords": ["חברים", "בדידות", "פופולרי", "דחייה", "בושה", "חברתי", "מסיבות", "בולינג"],
                "responses": [
                    """**בעיות חברתיות ובדידות** 👥

המתבגרות הן תקופה אינטנסיבית מבחינה חברתית - השתייכות לקבוצה זה לא "נחמד" אלא צורך חיוני.

`CARD[מה נורמלי ומה דורש התערבות|נורמלי: רצון להשתייך, לחץ חברתי, ריבים עם חברים. לא נורמלי: בדידות מוחלטת, הימנעות מכל מגע חברתי, או בולינג.]`

**אם המתבגר מתלונן על בעיות חברתיות:**

**1. אמת את הכאב - אל תזלזל**
- "זה באמת כואב כשמרגישים בחוץ"
- אל תגיד "תמצא חברים אחרים" - זה לא עוזר
- "ספר לי יותר על מה שקורה"

**2. עזור לפרק את הבעיה**
- "מה בדיוק קרה?"
- "איך הרגשת במצב הזה?"
- לעיתים רק השיתוף כבר עוזר

**3. בניית כישורים חברתיים**
- לא כולם נולדים עם כישורים חברתיים טבעיים
- "איך אתה חושב שהוא הרגיש כשאמרת את זה?"
- תרגול שיחות קלות בבית
- עידוד לפעילויות שמתאימות לאישיות שלו

**למקרי בולינג:**
- תמיד תאמין למתבגר שלך
- תתעד מקרים (תאריכים, מה קרה)
- פנה לבית הספר מיד
- עזור לו לפתח תגובות

**לגבי חרדה חברתית:**
- התחל בחשיפות קטנות (לומר שלום למישהו)
- תן כלים להרגעה לפני מצבים חברתיים
- חזק כל צעד קטן קדימה

[אמת את הכאב] [פרק את הבעיה] [בנה כישורים הדרגתית]"""
                ]
            },
            
            "general_support": {
                "keywords": ["לא יודע", "עזרה", "מה לעשות", "בבקשה", "תסכול", "קשה", "נואש", "אין לי כוח"],
                "responses": [
                    """**כשלא יודעים מה לעשות** 🤷‍♀️

ההורות למתבגרים לפעמים מרגישה כמו לנהוג בערפל. זה נורמלי.

`CARD[האמת על הורות מושלמת|אין דבר כזה הורה מושלם. כל הורה עושה טעויות. המטרה היא קשר טוב ולמידה מהטעויות.]`

**שאלות שעוזרות לכוון את הראש:**

**1. "מה המטרה שלי כאן?"**
- לזכות בוויכוח? לחנך? להגן? להבין?
- לפעמים הבהרת המטרה פותרת הכל

**2. "איך הייתי רוצה שיזכרו אותי?"**
- כהורה שתמיד צעק? או שתמיד ניסה להבין?
- כמי שהיה שם בזמנים קשים?

**3. "מה המתבגר שלי צריך עכשיו?"**
- חיבוק? גבולות? מרחב? הקשבה? 
- לפעמים השאלה הזו מבהירה הכל

**דברים שחשוב לזכור תמיד:**
- המתבגר שלך רוצה את האהבה שלך, גם אם זה לא נראה ככה
- הקשר חשוב יותר מכל טכניקה
- טעויות הן חלק מהתהליך - גם שלך וגם שלו

**ואם באמת לא יודע מה לעשות:**
- "אני לא יודע איך להגיב למצב הזה, בוא נחשוב יחד"
- זה לא חולשה - זה מלמד אותו שגם מבוגרים לא יודעים הכל

**מתי לבקש עזרה מקצועית:**
- כשיש סיכון לפגיעה (עצמית או באחרים)
- כשהמצב מתדרדר במשך שבועות
- כשאתה מרגיש שאבדת שליטה מוחלטת

[בהר המטרה] [זכור את החשיבות של הקשר] [הודה בחוסר ידיעה כשצריך]""",

                    """**עקרונות CBT להורות יומיומית** 🎯

כמה כלים מהטיפול הקוגניטיבי-התנהגותי שיעזרו לך כהורה:

`CARD[הכלל החשוב ביותר|המתבגר שלך צריך להרגיש שהוא נראה, נשמע ומובן - גם כשאתה לא מסכים איתו.]`

**1. שים לב למחשבות האוטומטיות שלך:**
- "הוא עושה את זה כדי להרגיז אותי" (באמת?)
- "אני הורה נורא" (או שפשוט מצב קשה?)
- "הוא אף פעם לא יצליח" (נכון? או שאתה מתוסכל?)

**2. אתגר הנחות יסוד:**
- מה אם מה שנראה כמו עקשנות זה בעצם פחד?
- מה אם מה שנראה כמו חוסר כבוד זה קושי להתבטא?
- מה אם הוא לא "עושה לך" אלא מתמודד עם משהו?

**3. התמקד בהתנהגויות, לא באישיות:**
- במקום: "אתה עצלן" → "אני רואה שקשה לך להתחיל משימות"
- במקום: "אתה אגואיסט" → "אשמח שתחשוב גם על האחרים"

**4. חיזוק חיובי יעיל יותר מעונש:**
- שים לב למה שהוא עושה טוב ותגיד לו
- "הבחנתי שהיית סבלני עם אחותך היום"
- "ראיתי שעזרת לסבתא בלי שביקשו ממך"

**5. מודל את מה שאתה רוצה לראות:**
- איך אתה מתמודד עם כעס?
- איך אתה מדבר על טעויות שלך?
- איך אתה מתנצל כשטועה?

**זכור: אתה לא לבד במסע הזה** ❤️

[שים לב למחשבות שלך] [אתגר הנחות] [חיזוק חיובי] [דוגמא אישית]"""
                ]
            }
        }
    
    def get_fallback_response(self, user_message: str) -> str:
        """מחזיר תשובה מוכנה מראש בהתבסס על הודעת המשתמש"""
        
        # ניקוי וטרנספורמציה של ההודעה
        clean_message = self._clean_message(user_message)
        
        # מציאת הקטגוריה הכי רלוונטית
        best_category = self._find_best_category(clean_message)
        
        if best_category:
            # בחירת תשובה מהקטגוריה
            response = self._select_response_from_category(best_category, clean_message)
            
            # הוספת הודעת הסבר על המצב
            prefix = "🤖 **המערכת שלי עמוסה כרגע, אבל אני עדיין כאן בשבילך!**\n\n"
            suffix = "\n\n💡 *אם תרצה עזרה מפורטת יותר, נסה שוב מאוחר יותר או פנה לעזרה מקצועית כשצריך.*"
            
            return prefix + response + suffix
        
        # תשובת ברירת מחדל
        return self._get_default_response()
    
    def _clean_message(self, message: str) -> str:
        """ניקוי ונרמול ההודעה"""
        # הסרת סימני פיסוק מיותרים ותווים מיוחדים
        message = re.sub(r'[^\w\s]', ' ', message.lower())
        # הסרת רווחים מרובים
        message = re.sub(r'\s+', ' ', message).strip()
        return message
    
    def _find_best_category(self, message: str) -> Optional[str]:
        """מציאת הקטגוריה הכי רלוונטית להודעה"""
        scores = {}
        
        for category, data in self.responses_db.items():
            score = 0
            keywords = data["keywords"]
            
            for keyword in keywords:
                if keyword.lower() in message:
                    # מילות מפתח יותר ארוכות מקבלות ציון גבוה יותר
                    score += len(keyword.split())
            
            if score > 0:
                scores[category] = score
        
        # מחזיר את הקטגוריה עם הציון הגבוה ביותר
        if scores:
            return max(scores.keys(), key=lambda k: scores[k])
        
        return None
    
    def _select_response_from_category(self, category: str, message: str) -> str:
        """בחירת תשובה ספציפית מהקטגוריה"""
        responses = self.responses_db[category]["responses"]
        
        if len(responses) == 1:
            return responses[0]
        
        # לוגיקה פשוטה - בחירה בהתבסס על אורך ההודעה
        # הודעה קצרה = תשובה ראשונה (כללית)
        # הודעה ארוכה = תשובה שנייה (מפורטת יותר)
        if len(message.split()) < 5:
            return responses[0]
        else:
            return responses[-1]  
    
    def _get_default_response(self) -> str:
        """תשובת ברירת מחדל כשלא מוצאת התאמה"""
        return """🤖 **המערכת שלי עמוסה כרגע, אבל אני עדיין רוצה לעזור!**

תודה שפנית אליי. גם אם אני לא יכול לתת לך תשובה מותאמת אישית כרגע, יש כמה דברים שתמיד כדאי לזכור:

`CARD[עקרון הבסיס|הקשר שלך עם המתבגר שלך הוא הדבר הכי חשוב. כל טכניקה עובדת רק כשיש אמון ואהבה.]`

**כמה עקרונות תמיד רלוונטיים:**
- **הקשב לפני שמגיב** - המתבגר שלך צריך להרגיש נשמע
- **שאל במקום להניח** - "איך אתה מרגיש?" מועיל יותר מ"אני יודע מה אתה מרגיש"
- **התמקד בהתנהגות, לא באישיות** - "ההתנהגות הזו לא מתאימה" במקום "אתה רע"

**ואם זה מצב דחוף:** אל תהסס לפנות לעזרה מקצועית.

[הקשבה קודם כל] [שאלות במקום הנחות] [עזרה מקצועית במצבי חירום]

💡 *נסה שוב מאוחר יותר לשיחה מפורטת יותר!*"""